chrome.action.onClicked.addListener(e=>{console.log("background: icon clicked, sending toggleSidebar to tab",e.id),e.url&&(e.url.startsWith("http://")||e.url.startsWith("https://"))?chrome.tabs.sendMessage(e.id,{action:"toggleSidebar"},r=>{chrome.runtime.lastError?console.log("background: content script not ready, error:",chrome.runtime.lastError.message):console.log("background: got response from content script",r)}):console.log("background: unsupported page type:",e.url)});chrome.runtime.onInstalled.addListener(()=>{console.log("AI Chat Extension installed")});chrome.runtime.onMessage.addListener((e,r,s)=>{if(console.log("background: received message from content script:",e),e.action==="callDoubaoAPI")return i(e.data,s),!0});async function i(e,r){var s,t,n;try{console.log("background: calling Doubao v3 API with data:",e);const o=await fetch("https://ark.cn-beijing.volces.com/api/v3/chat/completions",{method:"POST",headers:{Authorization:`Bearer ${e.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify({model:e.model||"doubao-seed-1.6-flash",messages:[{role:"user",content:e.message}],max_tokens:1500,temperature:.7,top_p:.9})});if(console.log("background: response status:",o.status),!o.ok){const a=await o.text();console.error("background: API request failed:",o.status,a),r({success:!1,error:`API request failed: ${o.status} - ${a}`});return}const c=await o.json();console.log("background: API response received:",c);const l=((n=(t=(s=c.choices)==null?void 0:s[0])==null?void 0:t.message)==null?void 0:n.content)||"Sorry, I could not generate a response.";r({success:!0,content:l})}catch(o){console.error("background: error calling Doubao API:",o),r({success:!1,error:o.message||"Network error occurred"})}}
