import{h as X,i as $}from"./DQCZLHJM.js";import{g as K,h as W,i as k,j as H,l as z}from"./XXMMBCVS.js";import{Ra as G,da as F,g as R,y as p}from"./VE4EMEBO.js";import{$a as U,E as d}from"./AUJ76673.js";import{e as L}from"./DOCIOFBQ.js";import{Aa as y,F as I,e as w,f as x,g as D,h as N,i as M,j as B}from"./MX3LYTPZ.js";import{I as S,L as E,N as b,V as O,b as g,l as A,m as T,n as l}from"./XZ5AIA7R.js";import{h as P}from"./GAV6HCJA.js";var q=3,_=class o extends ${static{this.databaseName="ConversationDB"}constructor(){super(o.databaseName),this.version(q).stores({conversations:"id,lastMessageId,authorId,name,created_at,updated_at,type,meta.domain",messages:"messageId,conversationId,parentMessageId,created_at,updated_at,type,[conversationId+created_at+messageId],is_deleted",attachments:"id,messageId,created_at,updated_at",conversationLocalStorage:"conversationId"}),this.conversations=this.table("conversations"),this.messages=this.table("messages"),this.attachments=this.table("attachments"),this.conversationLocalStorage=this.table("conversationLocalStorage")}};var v=class{async getConversationById(e){return e?d.fetch("/conversation/get_conversation",{method:"POST",body:JSON.stringify({id:e})}).then(t=>t.data?.status==="OK"?t.data.data?.[0]:null):null}async getConversationsByIds(e){return d.fetch("/conversation/get_conversations_basic_by_ids",{method:"POST",body:JSON.stringify({ids:e})}).then(t=>t.data?.status==="OK"?t.data.data:[])}async getBasicConversationById(e){return e?d.fetch("/conversation/get_conversations_basic_by_ids",{method:"POST",body:JSON.stringify({ids:[e]})}).then(t=>t.data?.status==="OK"?t.data.data?.[0]:null):null}async getBasicConversationByIds(e){return d.fetch("/conversation/get_conversations_basic_by_ids",{method:"POST",body:JSON.stringify({ids:e})}).then(t=>t.data?.status==="OK"?t.data.data:[])}async getPaginationConversationsByType(e,t){let{page:n,pageSize:r=20,sortKey:i="created_at",sortOrder:s="desc",isDelete:a=!1}=t;return d.fetchPaginationData("/conversation/get_conversation_list",{method:"POST",body:JSON.stringify({type:e,page:n,page_size:r,sort_key:i,sort:s,isDelete:a})})}async getPaginationBasicConversationsByType(e,t){let{page:n,pageSize:r=20,sortKey:i="created_at",sortOrder:s="desc",isDelete:a=!1}=t;return d.fetchPaginationData("/conversation/get_conversations_basic",{method:"POST",body:JSON.stringify({type:e,page:n,page_size:r,sort_key:i,sort:s,isDelete:a})})}async getPaginationSearchConversationsByType(e,t){let{keyword:n,page:r,pageSize:i=20,searchTime:s}=t;return d.fetchPaginationData("/conversation/search_conversations",{method:"POST",body:JSON.stringify({type:e,page:r,page_size:i,keyword:n||"",search_time:s||""})})}async getConversationAIProviderAndAIModel(e){let t=await this.getConversationById(e);return t?.meta?.AIProvider&&t?.meta?.AIModel?{AIProvider:t.meta.AIProvider,AIModel:t.meta.AIModel}:null}async getConversationPayWallModel(e){return""}async addOrUpdateConversation(e,t,n){let{isPartialUpdate:r=!0,syncToRemote:i=!0,updateUpdatedAt:s=!0}=n||{};if(!i)return null;let a=null;if(r){let c=await this.getConversationById(e);a=y([c||{},{id:e,...t,created_at:c?.created_at||t.created_at}])}else a=t;if(!a)return null;if(!a.authorId){let c=await p.getUserId();a.authorId=c||""}return s&&(a.updated_at=new Date().toISOString()),d.fetch("/conversation/upsert_conversation",{method:"POST",body:JSON.stringify(a)}).then(c=>c.data?.status==="OK"?a:null)}async softDeleteConversation(e){return(await this.addOrUpdateConversation(e,{isDelete:!0}))?.id===e}async softDeleteConversationByConversationType(e){return await d.fetch("/conversation/delete_conversation_by_type",{method:"POST",body:JSON.stringify({type:e})}).then(n=>n.data?.status==="OK")}async shareConversation(e,t){let n=await d.fetch("/conversation/share_conversation",{method:"POST",body:JSON.stringify({id:e,share_enabled:t})}).then(r=>r.data?.status==="OK"?r.data.data:null);return n?.id?await this.addOrUpdateConversation(e,{share:{enable:n.enabled,id:n.id}}):null}async checkUpdate(){return!1}},h=class{constructor(e){this.service=e,this.getCacheConversationsStorage=()=>X(_,"conversations")}async getCacheConversationsByType(e){return this.getCacheConversationsStorage().where({type:e}).toArray().then()}async getConversationById(e){return await this.getCacheConversationsStorage().get(e).then()||await this.service.getConversationById(e)}async getConversationsByIds(e){let t=await this.getCacheConversationsStorage().where({id:{$in:e}}).toArray().then();return t.length===e.length?t:this.service.getConversationsByIds(e)}async getBasicConversationById(e){return await this.getCacheConversationsStorage().get(e).then()||await this.service.getBasicConversationById(e)}async getBasicConversationByIds(e){let t=await this.getCacheConversationsStorage().where({id:{$in:e}}).toArray().then();return t.length===e.length?t:this.service.getBasicConversationByIds(e)}async getPaginationConversationsByType(e,t){return this.service.getPaginationConversationsByType(e,t)}async getPaginationBasicConversationsByType(e,t){return this.service.getPaginationBasicConversationsByType(e,t)}async getPaginationSearchConversationsByType(e,t){return this.service.getPaginationSearchConversationsByType(e,t)}async addOrUpdateConversation(e,t,n){let{syncToRemote:r=!0,isPartialUpdate:i=!0,updateUpdatedAt:s=!0}=n||{},a=null;if(i){let c=await this.getCacheConversationsStorage().get(e).then();a=y([c||{},{id:e,...t,created_at:c?.created_at||t.created_at}])}else a=t;if(!a.authorId){let c=await p.getUserId();a.authorId=c||""}return s&&(a.updated_at=new Date().toISOString()),await this.getCacheConversationsStorage().put(a).then(),a&&a.authorId&&r&&await this.service.addOrUpdateConversation(e,a,{syncToRemote:!0,isPartialUpdate:!1,updateUpdatedAt:!1}),a}async softDeleteConversation(e){let t=await this.service.softDeleteConversation(e);return t&&await this.addOrUpdateConversation(e,{isDelete:!0},{syncToRemote:!1,isPartialUpdate:!0,updateUpdatedAt:!0}),t}async softDeleteConversationByConversationType(e){let t=await this.service.softDeleteConversationByConversationType(e);if(t){let n=await p.getUserId(),i=(await this.getCacheConversationsByType(e)).filter(s=>s.authorId===n).map(s=>s.id);await this.getCacheConversationsStorage().bulkDelete(i).then()}return t}async getConversationAIProviderAndAIModel(e){let t=await this.getConversationById(e);return t?.meta?.AIProvider&&t?.meta?.AIModel?{AIProvider:t.meta.AIProvider,AIModel:t.meta.AIModel}:null}async shareConversation(e,t){let n=await this.service.shareConversation(e,t);return n?(await this.getCacheConversationsStorage().put(n).then(),n):null}async getConversationPayWallModel(e){return this.service.getConversationPayWallModel(e)}async checkUpdate(e){let t=await this.getCacheConversationsStorage().get(e).then();if(t?.meta.isUploaded!==!0)return!1;let n=!1,r=!1;if(!t)n=!0;else{let i=await d.fetch("/conversation/get_conversation_last_updated_time",{method:"POST",body:JSON.stringify({id:e})});if(i.data?.status==="OK"&&i.data?.data?.updated_at){let s=new Date(t.updated_at).getTime(),a=new Date(i.data.data.updated_at).getTime();s<a?n=!0:s>a&&(r=!0)}}if(n){let i=await this.service.getConversationById(e);i&&await this.getCacheConversationsStorage().put(i).then()}return t&&r&&await this.service.addOrUpdateConversation(e,t,{syncToRemote:!0,isPartialUpdate:!1,updateUpdatedAt:!1}),n||r}};P([R({cacheArgs:!0})],h.prototype,"getConversationById",1);var f=class{static{this.apiChatConversationService=new v}static{this.cachedChatConversationService=new h(new v)}static getService(e=!0){return e?this.cachedChatConversationService:this.apiChatConversationService}};var Y=o=>K.some(e=>e===o)?"reply":W.some(e=>e===o)?"new":k.some(e=>e===o)?"refine":!1;var C=o=>{if(o){let e=Y(o);return e?{promptType:"preset",instantType:e}:U.find(t=>t===o)||H.find(t=>t===o)?{promptType:"preset"}:{promptType:"custom"}}else return{promptType:"freestyle"}},Q=(o,e)=>{let t=o,n=e.meta?.MaxAIPromptActionConfig;if(n&&n.parent_prompt_id){let r=n.parent_prompt_id;r==="718dae5a-8c58-47a7-9089-5dc02cedbc3c"&&(t=`[Change tone] ${o}`),r==="4d226b15-9e21-42ba-8af8-57d6fbae5a3d"&&(t=`[Translate to] ${o}`)}return o==="[Summary] Summarize this page"&&(t="Summarize this page"),t},Me=async(o,e)=>{let t=L(o.meta?.analytics||{}),{prompt_id:n,prompt_title:r,path:i}=o?.meta?.MaxAIPromptActionConfig||{promptId:t.promptId,promptName:t.promptName};if(!t.promptType){let{promptType:a}=C(n);t.promptType=a}let s=o.conversationId?await f.getService().getConversationById(o.conversationId):null;return!t.featureName&&s&&(t.featureName=await j(s,n,i)),!t.platformFeature&&s&&(t.platformFeature=J({promptId:n,conversation:s,coverPlatformFeature:e})),t.promptId=n,t.promptName=r&&Q(r,o),t.sourceType=Z(o),t},j=async(o,e,t)=>{if(t){let n=z(t);if(["/compose_new","/compose_reply","/refine_draft"].includes(n))return"instant_reply"}if(o){let{promptType:n,instantType:r}=C(e);return n==="preset"&&(r==="refine"||r==="new"||r==="reply")?"instant_reply":o.type==="ContextMenu"||o.meta.isContextMenu?(await G.getAppSettings()).userSettings?.alwaysContinueInSidebar?"sidebar":"context_menu":E()?"immersive_chat":"sidebar"}else return"UNKNOWN"},Z=o=>{let e=n=>{let r=n.maxAIDocumentType,i=`.${I(n.title)}`,s=!1;try{s=n.link===window?.location.href}catch{s=!1}let a="NA";return r==="image"?(a="image_added",a):r==="page_content__pdf"?(a=s?"pdf_current":"pdf_added",a):r==="page_content__youtube"?(a=s?"youtube_current":"youtube_added",a):r==="page_content__email"?(a=s?"email_current":"email_added",a):r==="page_content__webpage"?(a=s?"webpage_current":"webpage_added",a):r==="search_results"?(a="search",a):w.includes(i)?(a="script_added",a):x.includes(i)?(a="config_added",a):D.includes(i)?(a="text_added",a):N.includes(i)?(a="sheet_added",a):M.includes(i)?(a="code_added",a):B.includes(i)?(a="audio_added",a):i==="."?(a="_added",a):`${I(n.title)}_added`};if(o.meta?.messageChatDocuments){let n=o.meta?.messageChatDocuments??[];if(n.length<=0)return"NA";if(n.length===1){let r=n[0];return r.maxAIDocumentType?e(r):"NA"}else if(n.length>1){let r=n.map(s=>e(s));return r.every(s=>s===r[0]&&s!=="NA")?r[0]:"mix"}}let t=o.meta?.contextMenu?.id||o.meta?.MaxAIPromptActionConfig?.prompt_id;if(t){let{instantType:n}=C(t);return n?"email_quote":"text_quote"}return"NA"};var Xe=()=>T?O().name==="Edge"?"edge_extension":"chrome_extension":"web",J=o=>{try{let e=l?"web":"browser",t=o?.fallbackValue??l?"app":"sidebar";if(o?.coverPlatformFeature){let c=`${e}_${o.coverPlatformFeature}`;return l&&c.includes("web_sidebar")&&(c=c.replace("web_sidebar","web_app")),c}if(o?.promptId){let c=o.promptId,u="",{promptType:m,instantType:V}=C(c);if(m==="preset"&&V)return u="page_ai_reply",`${e}_${u}`}let n=o?.conversation;if(n&&(n.type==="ContextMenu"||n.meta.isContextMenu))return`${e}_context_menu`;let r=o?.targetElement,i=r?.dataset?.shadowRootId??"";if(r){if(r.getAttribute("id")==="maxai-client--ai-message--next-action--use-prompt-action-item")return l?"web_app_related_rewrite":"browser_sidebar_related_rewrite";let c=r.getAttribute("data-platform-feature");if(c){let u=`${e}_${c}`;return l&&u.includes("web_sidebar")&&(u=u.replace("web_sidebar","web_app")),u}}if(r&&!l){let u=F(r)?.host;if(u){let m=u.tagName.toLowerCase();if(i=u.id,m.includes("max-ai")&&m.includes("summary-button"))return`${e}_page_summarize`;if(m.includes("maxai-input-assistant-button"))return`${e}_page_ai_reply`}}if(o?.rootContainerId&&(i=o.rootContainerId),i.includes("Minimize_Container"))return`${e}_quick_access`;if(i.includes("MAXAI_SEARCH_WITH_AI_ROOT_ID"))return`${e}_page_search_with_ai`;if(i.includes("USE_CHAT_GPT_AI_ROOT_Context_Menu")||r?.classList.contains("floating-context-menu-item"))return`${e}_context_menu`;if(i.includes("USE_CHAT_GPT_AI_ROOT")||i.includes("maxai-global-popup-container"))return`${e}_sidebar`;let s=!A,a=window.location.origin??S();if(b())return`${e}_setting`;if(l){let c=window.location.pathname;return(!s||a===g)&&c.includes("/app/")?`${e}_app`:(!s||a===g)&&c.includes("/ai-tools/ai-art")?`${e}_ai_art`:(!s||a===g)&&(c.includes("/ai-tools/")||c.includes("/pdf-tools/")||c.includes("/image-tools/")||c.includes("/file-tools/")||c.includes("/text-tools/"))?`${e}_free_tools`:`${e}_landing`}return t?`${e}_${t}`:"UNKNOWN"}catch{return"UNKNOWN"}};export{_ as a,v as b,h as c,f as d,C as e,Me as f,j as g,Z as h,Xe as i,J as j};
