import{d as Ce,h as Re,i as Le}from"./DQCZLHJM.js";import{a as ie}from"./X7IGDKSO.js";import{j as Se,n as Ue}from"./2HIYOEPI.js";import{G as W,Ga as j,Ja as A,b as re,g as G,ja as Oe}from"./VE4EMEBO.js";import{b as N,c as he}from"./UICGGF3X.js";import{E as Pe,G as te,H as Fe,O as E,P as f,S as Me,a as h,o as g}from"./AUJ76673.js";import{K as ne,e as k,l as z,x as oe}from"./DOCIOFBQ.js";import{Aa as ve,M as Ae,S as be,k as Te,m as De,n as T,p as v,q as _e,x as Ee}from"./MX3LYTPZ.js";import{D as ge,E as we,J as ye,l as ee,m as xe,n as Ie,u as b}from"./XZ5AIA7R.js";import{a as tt}from"./PJ57C2TE.js";import{f as et,h as B}from"./GAV6HCJA.js";var Be=et(tt()),Ne=Be.default.runtime.getURL("/assets/pdfjs/pdf.worker.min.mjs");var O=async()=>import("./RKVH7WQI.js").then(s=>(s.GlobalWorkerOptions.workerSrc=Ne||`https://cdn.jsdelivr.net/npm/pdfjs-dist@${s.version}/build/pdf.worker.min.mjs`,s)),D=async()=>import("./ZIXKS545.js"),ae=s=>({cMapUrl:`https://cdn.jsdelivr.net/npm/pdfjs-dist@${s}/cmaps/`,cMapPacked:!0});var P=s=>Object.values(Me).find(e=>T(s,e.extensions))||null,Et=async(s,e)=>{let{maxCount:t=3}=e||{},r=[],o=[],i=[];return s.forEach(a=>{let n=P(a);if(n){let{maxFileSize:c}=n;a.size>c?(i[c]||(i[c]=[]),i[c].push(a)):r.push({file:a,documentType:n.documentType})}else return o.push(a),!1}),o.length&&ne.error(h().t("package__features:document__upload_file__unsupported__title",{NAME:o.map(a=>a.name).join(",")}),{autoHideDuration:3e3}),Object.entries(i).forEach(([a,n])=>{ne.error(h().t("package__features:document__upload_file__oversize__title",{NAME:n.map(c=>c.name).join(","),MAX_SIZE:Fe(Number(a),2)}),{autoHideDuration:3e3})}),{supportedFiles:r.slice(0,t),unsupportedFiles:o,oversizeFiles:Object.values(i).flat()}},At=s=>s?P(s)?.documentType||"chat_file":"chat_file",se=s=>{if(s)try{let e=new URL(s).searchParams,t=e.get("X-Amz-Date")||"",r=e.get("X-Amz-Expires");if(!t||!r)return!1;let o=t.substring(0,8),i=t.substring(9,15),a=new Date(Date.UTC(Number(o.substring(0,4)),Number(o.substring(4,6))-1,Number(o.substring(6,8)),Number(i.substring(0,2)),Number(i.substring(2,4)),Number(i.substring(4,6))));if(a&&r&&new Date(new Date(a).getTime()+Number(r)*1e3).getTime()<new Date().getTime())return!0}catch{return!1}return!1};var Ot=(s,e)=>{try{return s.doc_type!==e?null:s.doc_type_dependent_data}catch{return null}},Ct=s=>Ie&&(re.pathname==="/share"||re.pathname==="/share/")?s==="page_content__webpage":!0;var H=class{constructor(e,t={}){this.source=e;this.options=t;this.pdfDoc=null}initPDFDoc(e){let{createDate:t,modifiedDate:r}=this.options;t&&e.setCreationDate(t),r&&e.setModificationDate(r)}async init(){let{PDFDocument:e}=await D();this.pdfDoc=await e.load(this.source,{updateMetadata:!1,password:this.options.password}),this.initPDFDoc(this.pdfDoc)}async cropByPageCount(e){if(this.pdfDoc&&this.pdfDoc.getPageCount()>e){let{PDFDocument:t}=await D(),r=await t.create({});(await r.copyPages(this.pdfDoc,Array.from({length:e},(i,a)=>a))).forEach(i=>r.addPage(i)),this.initPDFDoc(r),this.pdfDoc=r}}async cropByFileSize(e,t){if(!this.pdfDoc)return new Uint8Array([]);let r=e-500*1024,{removeImage:o}=t||{};try{let{PDFRawStream:i,PDFName:a}=await D();if(o){let d=this.pdfDoc.context.enumerateIndirectObjects(),u=[],m=0;for(let l=0;l<d.length;l++){let[,x]=d[l];if(x instanceof i){let{dict:w}=x;w.get(a.of("Subtype"))===a.of("Image")&&(u.push({object:x,contents:x.contents}),x.contents=new Uint8Array)}m+=x.sizeInBytes()}r&&m<r&&u.some(l=>{let x=l.contents;if(m+x.byteLength>r)return!0;l.object.contents=x,m+=x.byteLength})}let n=await this.pdfDoc.save(),c=this.pdfDoc.getPageCount();for(;n.length>r&&c>0;){let d=n.length/c,u=n.length-r,m=Math.max(Math.ceil(u/d),2);await this.cropByPageCount(c-m),c-=m,n=await this.pdfDoc.save()}return n}catch{}return new Uint8Array([])}async save(){return this.pdfDoc?this.pdfDoc.save():new Uint8Array([])}};var X=class{async compress(e,t){let{removeImage:r,maxFileSize:o,maxPageCount:i}=t||{};try{let a=e instanceof File?e.size:e.byteLength,n=e instanceof File?await e.arrayBuffer():e,c=new H(n,t);return await c.init(),i&&await c.cropByPageCount(i),a&&o&&a<o?c.save():o?c.cropByFileSize(o,{removeImage:r}):c.save()}catch{}return new Uint8Array([])}};var kt=new X;var V=class{async isEncryptedPDF(e){try{let t=await O();if(typeof e=="string"){if(await t.getDocument({url:e}).promise)return!1}else{let r=e.slice(0);if(await t.getDocument({data:r,disableAutoFetch:!0,disableStream:!0}).promise)return!1}}catch(t){if(t.name==="PasswordException")return!0}return!1}async checkPDFPassword(e,t){try{let{PDFDocument:r}=await D();return{pdfDoc:await r.load(e,{password:t}),isValid:!0}}catch{}return{isValid:!1}}async convertToUnencryptedPDF(e){try{let{PDFDocument:t}=await D();return(await t.load(e,{ignoreEncryption:!0})).save()}catch{}return null}async convertToTextPDF(e,t){let{password:r,reserve:o,createDate:i,modifiedDate:a}=t||{},n=t?.maxSize?t.maxSize-1024*1024:0;try{let{PDFDocument:c,PDFRawStream:d,PDFName:u}=await D(),m=await c.load(e,{updateMetadata:!1,password:r});i&&m.setCreationDate(i),a&&m.setModificationDate(a);let l=m.context.enumerateIndirectObjects(),x=[],w=0,R=I=>{let{dict:y}=I,L=y.get(u.of("Subtype"));(L===u.of("Image")||L===u.of("CIDFontType0C"))&&(x.push({object:I,contents:I.contents}),I.contents=new Uint8Array,w+=I.sizeInBytes())};for(let I=0;I<l.length;I++){let[,y]=l[I];if(y instanceof d)R(y);else{let L=y.sizeInBytes();w+=L}}return n&&o&&w<n&&x.some(I=>{let y=I.contents;if(w+y.byteLength>n)return!0;I.object.contents=y,w+=y.byteLength}),m.save()}catch{}return new Uint8Array([])}};var Vt=new V;var K=class{async extractTextAndPages(e,t){if(!T(e,[".pdf"])&&!e.type.includes("pdf"))return Promise.reject(new Error(`The file format (${"."+e.name.split(".").pop()}) is not supported yet. Try uploading a different file format.`));let r=await O(),{password:o}=t||{},i=ae(r.version),a=URL.createObjectURL(e),n=await r.getDocument(o?{url:a,password:o,...i}:{url:a,...i}).promise;return{text:await this.extractTextByPDFDocument(n,t),numPages:n.numPages}}async extractText(e,t){if(!T(e,[".pdf"])&&!e.type.includes("pdf"))return Promise.reject(new Error(`The file format (${"."+e.name.split(".").pop()}) is not supported yet. Try uploading a different file format.`));let r=await O(),{password:o}=t||{},i=ae(r.version),a=URL.createObjectURL(e),n=await r.getDocument(o?{url:a,password:o,...i}:{url:a,...i}).promise;return this.extractTextByPDFDocument(n,t)}async extractTextByPDFDocument(e,t){let{onProgress:r,separator:o=`
`}=t||{},i=e.numPages,a=async c=>{try{let u=await(await e.getPage(c)).getTextContent(),m="";return u.items.forEach(l=>{let x=l;m+=x.str,x.hasEOL&&(m+=`
`)}),m}catch{return""}},n="";for(let c=0;c<i;c++){c>0&&(n+=o),n+=await a(c+1);let d=(c+1)/i*100;r?.({loaded:c+1,total:i,progress:d})}return n}};var $=new K;var J=class{async generateFileDocument(e,t){let r=P(e);if(r?.documentType){if(r?.documentType==="audio")return this.generateAudioDocument(e,t);if(r?.documentType==="chat_file_excel")return this.generateExcelDocument(e,t);if(r?.documentType==="chat_file_docx")return this.generateDocxDocument(e,t);if(r?.documentType==="chat_file_pptx")return this.generatePptxDocument(e,t);if(r?.documentType==="chat_file_ebook")return this.generateEbookDocument(e,t);if(r?.documentType==="image")return this.generateImageDocument(e,t);if(r?.documentType==="page_content__pdf")return this.generatePDFDocument(e,t);let{override:o}=t||{},i=o?.doc_id||await f.createDocId(e),a=o?.pure_text||await v(e),{text:n,tokens:c}=await E(a,f.MAX_TEXT_TOKENS);return{doc_id:i,doc_type:r?.documentType==="chat_file_code"?"chat_file_code":"chat_file",pure_text:n,tokens:c,doc_type_dependent_data:{},file:e,file_mime_type:e.type,file_size:e.size}}else return Promise.reject(new Error(h().t("package__features:document__upload_file__unsupported__title",{NAME:e.name})))}async generateImageDocument(e,t){let{override:r}=t||{};return{doc_id:r?.doc_id||await f.createDocId(e),doc_type:"image",doc_type_dependent_data:{},file:e,file_mime_type:e.type,file_size:e.size}}async generateAudioDocument(e,t){let{override:r}=t||{};return{doc_id:r?.doc_id||await f.createDocId(e),doc_type:"audio",doc_type_dependent_data:{},file:e,file_mime_type:e.type,file_size:e.size}}async generatePDFDocument(e,t){let{override:r}=t||{},o=800,{text:i,numPages:a}=await $.extractTextAndPages(e).catch(m=>{throw m?.message==="No password given"?new Error(h().t("package__features:document__upload_pdf__no_password__title",{NAME:e.name})):m});if(a>o)throw new Error(h().t("package__features:document__upload_pdf__limit__title",{MAX_SIZE:"48MB",MAX_PAGES:o}));let n=r?.doc_id||await f.createDocId(e),c=r?.pure_text||i,{text:d,tokens:u}=await E(c,f.MAX_TEXT_TOKENS);return{doc_id:n,doc_type:"page_content__pdf",pure_text:d,tokens:u,doc_type_dependent_data:{},file:e,file_mime_type:e.type,file_size:e.size}}async generateExcelDocument(e,t){let{override:r}=t||{},o=r?.doc_id||await f.createDocId(e),i=T(e,[".csv"])?r?.pure_text||await v(e):"",{text:a,tokens:n}=await E(i,f.MAX_TEXT_TOKENS);return{doc_id:o,doc_type:"chat_file_excel",pure_text:a,tokens:n,doc_type_dependent_data:{},file:e,file_mime_type:e.type,file_size:e.size}}async generateDocxDocument(e,t){let{override:r}=t||{},o=r?.doc_id||await f.createDocId(e),i="",{text:a,tokens:n}=await E(i,f.MAX_TEXT_TOKENS);return{doc_id:o,doc_type:"chat_file_docx",pure_text:a,tokens:n,doc_type_dependent_data:{},file:e,file_mime_type:e.type,file_size:e.size}}async generatePptxDocument(e,t){let{override:r}=t||{},o=r?.doc_id||await f.createDocId(e),i="",{text:a,tokens:n}=await E(i,f.MAX_TEXT_TOKENS);return{doc_id:o,doc_type:"chat_file_pptx",pure_text:a,tokens:n,doc_type_dependent_data:{},file:e,file_mime_type:e.type,file_size:e.size}}async generateEbookDocument(e,t){let{override:r}=t||{},o=r?.doc_id||await f.createDocId(e),i="",{text:a,tokens:n}=await E(i,f.MAX_TEXT_TOKENS);return{doc_id:o,doc_type:"chat_file_ebook",pure_text:a,tokens:n,doc_type_dependent_data:{},file:e,file_mime_type:e.type,file_size:e.size}}async generateWebpageURLDocument(e,t){return j.generateDocument(e,t)}async generateSearchResultsDocument(e,t=200){let r=await f.createDocFile("search_results",e),o=await f.createDocId(r);return e.query&&t>0&&e.query.length>t&&(e.query=e.query.slice(0,t)),{doc_id:o,doc_type:"search_results",doc_type_dependent_data:e,file:r}}};var ce=new J;var Q=class{async loadFile(e,t){return ye(e)?this.loadLocalFile(e,t):this.loadRemoteFile(e,t)}async loadLocalFile(e,t){let{fileName:r,onProgress:o,abortSignal:i}=t||{},a=null;try{if(a=await A.createFileStreamer(e),!a||i?.aborted)return null;let n=await a.init();if(r&&(n.name=r),n.name||(n.name="File"),o?.({fileInfo:n,loaded:0,total:n.size,progress:0}),!n||i?.aborted)return null;let c=new Uint8Array([]),d=!1;for(;!d&&!i?.aborted;){let l=await a.getNextChunk();if(!l)break;d=l.done,c=he(c,new Uint8Array(l.value));let x=c.byteLength,w=n.size,R=x/w*100;o?.({fileInfo:n,loaded:x,total:w,progress:R})}if(i?.aborted)return null;let u=new Blob([c],{type:n.type});return new File([u],n.name,{type:n.type,lastModified:n.lastModified})}catch{}finally{a?.destroy()}return null}async loadRemoteFile(e,t){try{let{fileName:r,onProgress:o}=t||{},i=await fetch(e,{method:"GET"}),a=i.headers.get("content-type"),n=i.headers.get("content-length"),c=i.headers.get("last-modified"),d={url:e,name:r||e.split("/").pop()?.split("?")[0]||"",size:n?parseInt(n,10):0,type:a||"application/octet-stream",lastModified:c?new Date(c).getTime():void 0};return await Ee(e,m=>{o?.({fileInfo:d,...m})},d)}catch{return this.loadLocalFile(e,t)}}async extractFileText(e,t){return T(e,[".pdf"])?$.extractText(e,t).catch(r=>r?.message==="No password given"?Promise.reject(new Error("Upload Failed: Encrypted PDF are not supported. Please select a different file.")):Promise.reject(r)):De(e)?"":v(e,t?.onProgress)}};var Ge=new Q;var rt=1,q=class s extends Le{static{this.databaseName="DocumentDB"}constructor(){super(s.databaseName),this.version(rt).stores({documents:"doc_id,doc_type,link"}),this.documents=this.table("documents")}};var Y=class{constructor(){}getCacheStorage(){return Re(q,"documents")}async getDocumentById(e,t){let r=t?.expiredTime,o=await this.getCacheStorage().get(e).then();return o&&r&&(o.updated_at?new Date(o.updated_at).getTime():0)+r<Date.now()?null:o}async getDocumentByUrl(e,t){let r=t?.expiredTime,i=(await this.getCacheStorage().where({link:e}).toArray().then().then(a=>Ue(a,"updated_at")))[0];return i&&r&&(i.updated_at?new Date(i.updated_at).getTime():0)+r<Date.now()?null:i}async cacheDocument(e){return e.link&&await this.getCacheStorage().where({link:e.link}).delete().then(),await this.getCacheStorage().put({...e,updated_at:new Date().toISOString(),file:void 0}).then(),e}};var _=new Y;function ze(s,e){let{condition:t,continueOnError:r=!1,onComplete:o,onError:i}=s,a,n;return{onResult:c=>(a=c,t&&t(c)||!t&&c!==null&&c!==void 0?(o&&o(),e({data:a}),!0):!1),onError:c=>(n=c,i&&c instanceof Error&&i(c),r?!1:(e({error:n}),!0)),onComplete:()=>{o&&o(),e({data:a,error:n})}}}function je(s,e,t){setTimeout(()=>{s.stop(),e.onComplete()},t+100)}async function ke(s,e){return new Promise(t=>{let{interval:r,maxExecutions:o=0,immediate:i=!0,condition:a,signal:n}=e,c=ze(e,t),d=ie(async()=>{try{let u=await s();c.onResult(u)&&d.stop()}catch(u){c.onError(u)&&d.stop()}},{interval:r,maxExecutions:o,immediate:i,continueOnError:!0,onComplete:c.onComplete,signal:n});o===1&&!a&&je(d,c,r)})}async function We(s,e){return new Promise(t=>{let{interval:r,maxExecutions:o=0,immediate:i=!0,condition:a,signal:n}=e,c=ze(e,t),d=ie(()=>{try{let u=s();c.onResult(u)&&d.stop()}catch(u){c.onError(u)&&d.stop()}},{interval:r,maxExecutions:o,immediate:i,continueOnError:!0,onComplete:c.onComplete,signal:n});o===1&&!a&&je(d,c,r)})}async function ot(s,e,t){try{let r=await s();return e.condition&&e.condition(r)||!e.condition&&r!==null&&r!==void 0?(t({data:r}),{shouldContinue:!1,latestResult:r,latestError:null}):{shouldContinue:!0,latestResult:r,latestError:null}}catch(r){let o=r;return e.onError&&r instanceof Error&&e.onError(r),e.continueOnError?{shouldContinue:!0,latestResult:null,latestError:o}:(t({error:o}),{shouldContinue:!1,latestResult:null,latestError:o})}}function He(s,e){return new Promise(t=>{let r=s();if(r instanceof Promise)r.then(async i=>{if(e.condition&&e.condition(i)||!e.condition&&i!==null&&i!==void 0){e.onComplete&&e.onComplete(),t({data:i});return}let{shouldContinue:a}=await ot(()=>Promise.resolve(i),e,t);if(!a)return;let n=e.maxExecutions&&e.maxExecutions>0?e.maxExecutions-1:e.maxExecutions;return ke(()=>s(),{...e,maxExecutions:n,immediate:!0}).then(t)}).catch(i=>{if(e.onError&&i instanceof Error&&e.onError(i),!e.continueOnError){t({error:i});return}ke(()=>s(),e).then(t)});else try{let i=r;if(e.condition&&e.condition(i)||!e.condition&&i!==null&&i!==void 0){e.onComplete&&e.onComplete(),t({data:i});return}let a=e.maxExecutions&&e.maxExecutions>0?e.maxExecutions-1:e.maxExecutions;We(()=>s(),{...e,maxExecutions:a,immediate:!0}).then(t)}catch(i){if(e.onError&&i instanceof Error&&e.onError(i),!e.continueOnError){t({error:i});return}We(()=>s(),e).then(t)}})}var Xe={alwaysOnTop:!1,focused:!0,width:800,height:600,id:"",incognito:!1,left:0,top:0,type:"normal",ref:null,tabs:[],maxTabs:1,hiddenTabBar:!0},Ve={favIconUrl:"",status:"loading",discarded:!1,pinned:!1,groupId:0,lastAccessed:new Date().toISOString(),index:0,active:!0,id:"",windowId:""};var S=class{constructor(e){this.id=e.id||g(),this.windowId=e.windowId,this.active=e.active,this.status=e.status,this.title=e.title,this.index=e.index,this.lastAccessed=e.lastAccessed,this.favIconUrl=e.favIconUrl,this.width=e.width,this.height=e.height,this.openerTabId=e.openerTabId,this.documentId=e.documentId,this.documentType=e.documentType,this.artifact=e.artifact,this.viewerController=e.viewerController,this.viewerProps=e.viewerProps,this.groupId=e.groupId,this.pinned=e.pinned,this.autoDiscardable=e.autoDiscardable,this.audible=e.audible,this.discarded=e.discarded,this.highlighted=e.highlighted,this.incognito=e.incognito,this.mutedInfo=e.mutedInfo,this.pendingUrl=e.pendingUrl,this.url=e.url,this.customRender=e.customRender}};var U=class{constructor(e){this.alwaysOnTop=e.alwaysOnTop,this.focused=e.focused,this.width=e.width,this.height=e.height,this.id=e.id||g(),this.incognito=e.incognito,this.left=e.left,this.top=e.top,this.type=e.type,this.maxTabs=e.maxTabs,this.hiddenTabBar=e.hiddenTabBar,this.ref=e.ref}get tabs(){return p.getAllInWindow(this.id)}};var de=class extends N{constructor(){super(),this.windows=[]}async create(e){let t={...Xe,...e,id:e.id||g()},r=new U(t);return r.focused&&this.windows.forEach(o=>{o.focused=!1}),this.windows=[...this.windows,r],this.emit("onCreated",r),r}async get(e){return this.windows.find(t=>t.id===e)}async getAll(){return this.windows}async getCurrent(){return this.windows.find(e=>e.focused)||null}async remove(e){this.windows=this.windows.filter(r=>r.id!==e),!await this.getCurrent()&&this.windows.length>0&&await this.update(this.windows[0].id,{focused:!0}),this.emit("onDestroyed",e)}async update(e,t){let r=this.windows.find(o=>o.id===e);r&&(this.windows=this.windows.map(o=>o.id===e?ve([o,t]):o),this.emit("onUpdated",r))}},nt=new de,F=nt;var ue=class extends N{constructor(){super(),this.tabs=[]}async captureVisibleTab(){}async create(e){let t={...Ve,...e,lastAccessed:new Date().toISOString(),index:0},r=null;t.windowId||(r=await F.getCurrent(),r||(r=await F.create({})),t.windowId=r.id),t.id||(t.id=g()),!t.favIconUrl&&t.url&&ge(t.url)&&(t.favIconUrl=we(t.url,32));let o=r&&r.tabs.length>=r.maxTabs?[...r.tabs].sort((a,n)=>a.index-n.index)[0]:null;if(o)if(r&&r.tabs.length>1)this.remove(o.id);else{let a={...t};return Object.keys(o).forEach(n=>{typeof a[n]>"u"&&(a[n]=void 0)}),await this.update(o.id,a),o}r&&r.tabs.length>0?(t.active&&r.tabs.forEach(a=>{a.active&&(a.active=!1,this.emit("onActiveChanged",a))}),t.index=r.tabs.length):(t.index=0,t.active=!0);let i=new S(t);return this.tabs.push(i),this.emit("onCreated",i),i}async discard(e){let t=this.tabs.find(r=>r.id===e);t&&(t.discarded=!0,this.emit("onUpdated",{...t,discarded:!0}))}duplicate(e){let t=this.tabs.find(r=>r.id===e);if(t)return this.create({...t,id:g()})}get(e){return this.tabs.find(t=>t.id===e)}getAll(){return this.tabs}getAllInWindow(e){return this.tabs.filter(t=>t.windowId===e)}async getCurrent(){let e=await F.getCurrent();if(e)return this.tabs.find(t=>t.windowId===e.id&&t.active)}async move(e,t){let r=this.tabs.find(i=>i.id===e);if(!r)return;let o=r.windowId;if(t.windowId){let i=t.windowId;r.windowId=t.windowId,this.emit("onDetached",r.id,{oldPosition:r.index,oldWindowId:o}),this.emit("onAttached",r,{newPosition:r.index,newWindowId:i})}r.index=t.index,this.emit("onMoved",r,{fromIndex:r.index,toIndex:t.index})}async query(e){let t=await F.getCurrent();if(!t)return[];let r=e.currentWindow?this.tabs.filter(a=>a.windowId===t.id):this.tabs,{currentWindow:o,...i}=e;return r.filter(a=>Object.keys(i).every(n=>n==="artifactId"?a.artifact?.identifier===e.artifactId:a[n]===e[n]))}async remove(e){let t=this.tabs.findIndex(i=>i.id===e);if(t===-1)return;let r=this.tabs[t].windowId,o=this.tabs[t+1]||this.tabs[t-1];this.tabs=this.tabs.filter(i=>i.id!==e),this.emit("onRemoved",e),o&&await this.update(o.id,{active:!0}),this.tabs.length===0&&r&&await F.remove(r)}async update(e,t){let r=this.tabs.find(o=>o.id===e);r&&(t.active&&this.tabs.forEach(o=>{o.active&&(o.active=!1,this.emit("onActiveChanged",o))}),Object.assign(r,t),this.emit("onUpdated",r))}},it=new ue,p=it;var Ke=s=>{let e=s.id||g(),t={hideTitleBar:!1,hideToolbar:xe,...s.viewerProps,titleBarProps:{onClose(){p.remove(e)},...s.viewerProps?.titleBarProps}};return{...s,id:e,viewerProps:t}},Z=class{async previewDocument(e,t,r){let{waitToLoaded:o=!1,loadTimeout:i=b.SECOND*20}=r||{},a=await p.query({documentId:e}),n=a[0];return n?.id?await p.update(a[0].id,{active:!0}):n=await p.create(Ke({documentId:e,...t})),o&&n.status==="loading"?new Promise(c=>{let d=setTimeout(()=>{c(n),p.removeListener("onUpdated",u),p.removeListener("onRemoved",m)},i),u=l=>{l.id===n.id&&l.status!=="loading"&&(c(l),p.removeListener("onUpdated",u),p.removeListener("onRemoved",m),clearTimeout(d))},m=l=>{l===n.id&&(c(n),n.viewerController=null,p.removeListener("onUpdated",u),p.removeListener("onRemoved",m),clearTimeout(d))};p.addListener("onUpdated",u),p.addListener("onRemoved",m)}):n}async previewWebpage(e,t,r){let{waitToLoaded:o=!1,loadTimeout:i=b.SECOND*20}=r||{},n=(await p.query({url:e}))[0];return n?.id?await p.update(n.id,{active:!0}):n=await p.create(Ke({url:e,...t})),o&&n.status==="loading"?new Promise(c=>{let d=setTimeout(()=>{c(n),p.removeListener("onUpdated",u),p.removeListener("onRemoved",m)},i),u=l=>{l.id===n.id&&l.status!=="loading"&&(c(l),p.removeListener("onUpdated",u),clearTimeout(d))},m=l=>{l===n.id&&(c(n),n.viewerController=null,p.removeListener("onUpdated",u),p.removeListener("onRemoved",m),clearTimeout(d))};p.addListener("onUpdated",u),p.addListener("onRemoved",m)}):n}async pingWebpage(e,t){let r=await A.pingIframePage(e),o=0;for(;r===null&&o<t;)r=await A.pingIframePage(e),t+=1;return r}};var me=new Z;var $e=(s,...e)=>{let t=e.reduce((r,o)=>i=>o(r(i)),r=>r);return(...r)=>t(s(...r))};var at=s=>{let e=k(s);for(let t=0;t<e.length;t++){let r=e[t];r.speaker||(r.speaker="Speaker"),r._index=t}return e},le=$e(at);var st=["emails.content","description","comments.content","transcripts.text","sources.pageContent"],Je=s=>{let e=t=>t.replace(/(\s{3,}|\t{2,}|\n{2,})/g,r=>r.includes("	")?"		":r.includes(`
`)?`

`:"  ");return s.pure_text&&!["chat_file","chat_file_code"].includes(s.doc_type)&&(s.pure_text=e(s.pure_text)),st.forEach(t=>{let r=t.split("."),o=s.doc_type_dependent_data;for(let a=0;a<r.length-1;a++){let n=r[a];if(z(o,n)===void 0)return;o=o[n]}let i=r[r.length-1];typeof o=="string"?s.doc_type_dependent_data[i]=e(o):be(o)?o.forEach(a=>{z(a,i)&&oe(a,i,e(a[i]))}):Ae(o)&&z(o,i)&&oe(o,i,e(o[i]))}),s},Qe=s=>{let e=s.doc_type,t=s.doc_type_dependent_data;switch(e){case"audio":{let r=t?.segments;r&&(t.segments=le(r));break}default:break}return s},pe=s=>{let e=s.doc_type,t=s.doc_type_dependent_data;switch(e){case"audio":{let r=t?.segments;r&&(t.segments=le(r));break}default:break}return s};var qe=(s,e)=>{try{Ce("error_showed",{actions:s,details:e})}catch{}};var fe=(s={})=>{let{filteredOutKeys:e=["pure_text","file","doc_type_dependent_data"]}=s;return(t,r,o)=>{let i=o.value;return o.value=async function(...a){let n=await i.apply(this,a);if(n.success===!1)try{let c=k(a);c.forEach((d,u)=>{typeof d=="object"&&!Array.isArray(d)&&(c[u]=Se(d,e))}),qe("add_sources",{errorMessage:n.message??n.reason,inputParams:c,methodName:String(r)})}catch{}return n},o}};var Ye=(s,e)=>{let{code:t}=s,r=h()?.t;if(!r)return null;switch(t){case 20027:return r("package__features:document__error__file_too_large");default:return null}};function ct(s,e){let t=e.split(".").pop()?.toLowerCase()||"",r={"image/jpeg":"image","image/jpg":"image","image/png":"image","image/gif":"image","image/webp":"image","text/plain":"chat_file","application/pdf":"page_content__pdf","text/html":"page_content__webpage","application/vnd.ms-excel":"chat_file_excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"chat_file_excel","text/markdown":"chat_file_markdown","audio/mpeg":"audio","audio/mp3":"audio","audio/mpeg3":"audio","audio/x-mpeg-3":"audio","audio/wav":"audio","audio/vnd.wav":"audio","audio/vnd.wave":"audio","audio/wave":"audio","audio/x-pn-wav":"audio","audio/x-wav":"audio","audio/ogg":"audio","audio/flac":"audio","audio/x-flac":"audio"},o={jpg:"image",jpeg:"image",png:"image",txt:"chat_file",pdf:"page_content__pdf",html:"page_content__webpage",htm:"page_content__webpage",xls:"chat_file_excel",xlsx:"chat_file_excel",md:"chat_file_markdown",mp3:"audio",wav:"audio",ogg:"audio",flac:"audio"};return Object.keys(Te).forEach(i=>{o[i]="chat_file_code"}),s in r?r[s]:t in o?o[t]:null}var dt={"image/jpeg":[255,216,255],"image/png":[137,80,78,71],"application/pdf":[37,80,68,70],"application/zip":[80,75,3,4],"image/gif":[71,73,70,56],"audio/mpeg":[73,68,51],"audio/wav":[82,73,70,70],"audio/ogg":[79,103,103,83],"audio/flac":[102,76,97,67]};function ut(s,e){for(let t=0;t<e.length;t++)if(s[t]!==e[t])return!1;return!0}async function mt(s){let e=null,t=W()?(await A.proxyFetch(s,{method:"HEAD"}))?.responseRaw:(await Pe.fetch(s,{method:"HEAD"}))?.response;e=t?.header["content-type"]||t?.header["Content-Type"]||null;let r=e?.split(";")[0]?.trim()||null;return e==="application/octet-stream"?await lt(s):r}var lt=async s=>{let r=await(await(await fetch(s)).blob()).slice(0,4).arrayBuffer(),o=new Uint8Array(r);for(let[i,a]of Object.entries(dt))if(ut(o,a))return i;return"unknown"};async function Ze(s){let e=await mt(s);return e?ct(e,s):null}var M=class{async analyzeToDocument(e,t){try{let r=await this.analyzeToDocumentType(e);r==="image"&&typeof window<"u"&&document.contentType==="text/html"&&(r="page_content__webpage");let o=async function(n){let c=new URL(n).pathname.split("/").pop()||"untitled_file";if(W())return await Ge.loadLocalFile(n);try{let u=await(await fetch(n)).blob(),m=u.type;return["audio/mp3","audio/mpeg3","audio/x-mpeg-3"].includes(m)&&(m="audio/mpeg"),new File([u],c,{type:m})}catch{return null}},i=async function(n){let c=await f.createDocId(n),d=await _.getDocumentById(c,{expiredTime:ee?1:b.DAY,...t});if(d&&d.doc_type===r)return{success:!0,data:{...d,file:n}};let u=await ce.generateFileDocument(n,t);if(u)return _.cacheDocument(u),{success:!0,data:u}},a=async function(n){let c=await o(n);if(c){let d=await i(c);if(d)return d}else return{success:!1,data:null,reason:te(1012)}};if(e instanceof File){let n=await i(e);if(n)return n}if(r==="page_content__webpage"||r==="page_content__email"||r==="page_content__youtube"){let n=typeof e=="string"?e:"";if(e instanceof URL&&(n=e.toString()),window.location.href!==n){if("page_content__webpage"===r){let u=await Ze(n);if(u&&"page_content__webpage"!==u){let m=await a(n);if(m)return m}}let d=await _.getDocumentByUrl(n,{expiredTime:ee?1:15*b.MINUTE,...t});if(d)return{success:!0,data:{...d,file:await j.generateDocumentFile(d.doc_type,d.doc_type_dependent_data||{},{pureText:d.pure_text})}}}let c=await ce.generateWebpageURLDocument(n,t);if(c)return _.cacheDocument(c),{success:!0,data:c}}if(typeof e=="string")try{if(r==="image"){let n=await a(e);if(n)return n}else if(r==="chat_file"){let n=await _e(e,"data.txt");return this.analyzeToDocument(n,t)}}catch{}}catch(r){return{success:!1,data:null,reason:r.message||te(1012)}}return{success:!1,data:null,reason:"unsupported type"}}analyzeToDocumentType(e){if(e instanceof File)return P(e)?.documentType||null;let t=null;if(e instanceof URL&&(t=e),typeof e=="string")try{t=new URL(e)}catch{return"chat_file"}return t?Oe(t.toString()):null}isDocumentExpired(e){return f.isNeedUploadToS3(e.doc_type)?!e.s3?.doc_url||se(e.s3.doc_url):e.s3?.doc_url?se(e.s3.doc_url):!1}async uploadDocument(e,t){let r=await f.uploadDocument(Je(e),{getCustomErrorMessage:o=>Ye(o,e),...t});if(r.success&&r.data){let o=Qe(r.data);await _.cacheDocument(o),r.data=o}return r}async downloadDocument(e,t){let r=await _.getDocumentById(e);if(r&&!this.isDocumentExpired(r)&&!t?.forceUpdate)return{success:!0,data:pe(r),message:"",error:null,options:{}};let o=await f.fetchDocument(e,t);return o.success&&o.data&&(o.data=pe(o.data),await _.cacheDocument(o.data)),o}async previewDocument(e,t,r){return me.previewDocument(e,t,r)}async previewWebpage(e,t,r){return me.previewWebpage(e,t,r)}async pollingCheckDocumentTask(e,t){let{data:r,error:o}=await He(async()=>(await f.checkDocumentTask(e,{signal:t?.signal})).data?.status,{interval:1e3,immediate:!0,condition:i=>i==="done",...t});return!(o||r!=="done")}};B([G({cacheKey:(...e)=>{let[t]=e;return typeof t=="string"?JSON.stringify(e):null}}),fe()],M.prototype,"analyzeToDocument",1),B([fe(),G({cacheKey:(...e)=>{let t=e[0];return`${t.doc_id}_${t.doc_type}`}})],M.prototype,"uploadDocument",1),B([G({cacheArgs:!0})],M.prototype,"downloadDocument",1);var bn=new M;export{P as a,Et as b,At as c,se as d,Ot as e,Ct as f,Ne as g,ae as h,H as i,Vt as j,ce as k,Ge as l,F as m,p as n,me as o,qe as p,q,bn as r};
