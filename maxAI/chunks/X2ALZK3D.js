import{B as k,g as A,r as U,v as me}from"./VE4EMEBO.js";import{b as K}from"./UICGGF3X.js";import{E as x,f as H,j as Y,l as V,m as $,n as X,s as v}from"./AUJ76673.js";import{A as J}from"./DOCIOFBQ.js";import{ya as E}from"./MX3LYTPZ.js";import{a as z}from"./4B6UFNBQ.js";import{c as fe,f as p,h as R}from"./GAV6HCJA.js";var ie=fe((Rt,se)=>{var ye="Expected a function",oe=NaN,pe="[object Symbol]",Ee=/^\s+|\s+$/g,Ue=/^[-+]0x[0-9a-f]+$/i,Ie=/^0b[01]+$/i,be=/^0o[0-7]+$/i,Me=parseInt,Ce=typeof global=="object"&&global&&global.Object===Object&&global,_e=typeof self=="object"&&self&&self.Object===Object&&self,Te=Ce||_e||Function("return this")(),Re=Object.prototype,xe=Re.toString,Ae=Math.max,Pe=Math.min,B=function(){return Te.Date.now()};function Le(e,t,r){var n,o,l,u,i,s,a=0,f=!1,d=!1,m=!0;if(typeof e!="function")throw new TypeError(ye);t=ae(t)||0,N(r)&&(f=!!r.leading,d="maxWait"in r,l=d?Ae(ae(r.maxWait)||0,t):l,m="trailing"in r?!!r.trailing:m);function h(g){var S=n,y=o;return n=o=void 0,a=g,u=e.apply(y,S),u}function Q(g){return a=g,i=setTimeout(T,t),f?h(g):u}function _(g){var S=g-s,y=g-a,G=t-S;return d?Pe(G,l-y):G}function W(g){var S=g-s,y=g-a;return s===void 0||S>=t||S<0||d&&y>=l}function T(){var g=B();if(W(g))return j(g);i=setTimeout(T,_(g))}function j(g){return i=void 0,m&&n?h(g):(n=o=void 0,u)}function de(){i!==void 0&&clearTimeout(i),a=0,n=s=o=i=void 0}function ge(){return i===void 0?u:j(B())}function F(){var g=B(),S=W(g);if(n=arguments,o=this,s=g,S){if(i===void 0)return Q(s);if(d)return i=setTimeout(T,t),h(s)}return i===void 0&&(i=setTimeout(T,t)),u}return F.cancel=de,F.flush=ge,F}function N(e){var t=typeof e;return!!e&&(t=="object"||t=="function")}function Oe(e){return!!e&&typeof e=="object"}function Fe(e){return typeof e=="symbol"||Oe(e)&&xe.call(e)==pe}function ae(e){if(typeof e=="number")return e;if(Fe(e))return oe;if(N(e)){var t=typeof e.valueOf=="function"?e.valueOf():e;e=N(t)?t+"":t}if(typeof e!="string")return e===0?e:+e;e=e.replace(Ee,"");var r=Ie.test(e);return r||be.test(e)?Me(e.slice(2),r?2:8):Ue.test(e)?oe:+e}se.exports=Le});var I=p(me());var b=class{constructor(){this.cacheService=new U({saveKey:"MAXAI_CLIENT__FEATURES__BILLING__FEATURES_USAGE",cacheTime:t=>(0,I.default)().isSame((0,I.default)(t),"day")})}async fetchFeaturesQuota(){let t=await x.fetch("/user/get_user_feature_quota");if(t.data?.status==="OK"){let r=t.data.data;return{summarizePage:{dailyQuota:r.SUMMARIZE_PAGE_REQUEST_MAX_CNT},summarizePDF:{dailyQuota:r.SUMMARIZE_PDF_REQUEST_MAX_CNT},summarizeYoutube:{dailyQuota:r.SUMMARIZE_YOUTUBE_VIDEO_REQUEST_MAX_CNT},contextMenu:{dailyQuota:r.CONTEXT_MENU_REQUEST_MAX_CNT},search:{dailyQuota:r.SEARCH_REQUEST_MAX_CNT},instantReply:{dailyQuota:r.INSTANT_REPLY_REQUEST_MAX_CNT}}}return null}async getFeaturesUsage(t){let r={summarizePage:{dailyQuota:0,todayUsage:0},summarizePDF:{dailyQuota:0,todayUsage:0},summarizeYoutube:{dailyQuota:0,todayUsage:0},contextMenu:{dailyQuota:100,todayUsage:0},instantReply:{dailyQuota:0,todayUsage:0},search:{dailyQuota:0,todayUsage:0},refreshTime:""},n=await this.cacheService.get();if(n.data&&(r=E(r,n.data)),t||n.expired){let o=await this.fetchFeaturesQuota();o&&(r=E(r,o),await this.cacheService.sync(r))}return(!r.refreshTime||!(0,I.default)().isSame((0,I.default)(r.refreshTime),"day"))&&(r=E(r,{refreshTime:new Date().toISOString(),summarizePage:{todayUsage:0},summarizePDF:{todayUsage:0},summarizeYoutube:{todayUsage:0},contextMenu:{todayUsage:0},instantReply:{todayUsage:0},search:{todayUsage:0}}),await this.cacheService.set(r)),r}async setFeaturesUsage(t,r){let n=await this.getFeaturesUsage(!1);n[t].todayUsage=r,await this.cacheService.set(n)}async syncFeaturesUsage(){return this.getFeaturesUsage(!0)}async clearFeaturesUsage(){await this.cacheService.clear()}};R([A()],b.prototype,"getFeaturesUsage",1);var q="CHROME_EXTENSION_USE_CHAT_GPT_AI_USER_FEATURE_QUOTA_SAVE_KEY",P=class extends b{constructor(){super(),this.init()}async init(){let t=await v.getItem(q);if(t){await v.remove(q);let r={contextMenu:{dailyQuota:t.contextMenuMaxCnt||0,todayUsage:t.contextMenuUsage||0},instantReply:{dailyQuota:t.instantReplyMaxCnt||0,todayUsage:t.instantReplyUsage||0},summarizePage:{dailyQuota:t.summarizePageMaxCnt||0,todayUsage:t.summarizePageUsage||0},summarizePDF:{dailyQuota:t.summarizePDFMaxCnt||0,todayUsage:t.summarizePDFUsage||0},summarizeYoutube:{dailyQuota:t.summarizeYoutubeMaxCnt||0,todayUsage:t.summarizeYoutubeUsage||0},search:{dailyQuota:t.searchMaxCnt||0,todayUsage:t.searchUsage||0},refreshTime:t.refreshTime};await this.cacheService.set(r,{syncTime:t.checkTime})}}};var Ze=new P;var M=class extends K{constructor(){super(...arguments);this.modelUsageCacheService=new U({saveKey:"MAXAI_CLIENT__FEATURES__BILLING__MODEL_USAGE",cacheTime:U.DAILY})}async fetchModelUsage(){let r=await x.fetch("/user/get_user_quota_usage");if(r.data?.status==="OK"){let n=r.data.data;return{fastText:n.fast_text,advancedText:n.advanced_text,imageGenerate:n.image_generate,contentChat:n.content_chat,nextRefreshTime:n.next_refresh_time,proChat:n.pro_chat,proChatReward:n.pro_chat_reward}}return null}async getModelUsage(r){let n={fastText:0,advancedText:0,imageGenerate:0,contentChat:0,proChat:0,proChatReward:0},o=await this.modelUsageCacheService.get();if(o.data&&(Object.assign(n,o.data),o.data={...n}),r||o.expired){let l=await this.fetchModelUsage();l&&(Object.assign(n,l),await this.modelUsageCacheService.sync(n))}return o.data&&(o.data.proChat!==n.proChat||o.data.proChatReward!==n.proChatReward)&&this.emit("onUsageChange",o.data,n),n}async refreshModelUsage(){return await this.getModelUsage(!0)}async clearModelUsage(){await this.modelUsageCacheService.clear()}};R([A()],M.prototype,"getModelUsage",1);var Z="CHROME_EXTENSION_USE_CHAT_GPT_AI_USER_QUOTA_USAGE_SAVE_KEY",L=class extends M{constructor(){super(),this.init()}async init(){let t=await v.getItem(Z);t&&(await v.remove(Z),await this.modelUsageCacheService.set(t))}};var O=new L;var C=H({key:"BillingModelUsageModelAtom",default:{fastText:0,advancedText:0,imageGenerate:0,contentChat:0,proChat:0,proChatReward:0,loading:!1}});var w=p(z());var he=()=>Y(C),Se=()=>{let e=V(C),t=$(C),r=(0,w.useCallback)(s=>{e(a=>a.loading===s?a:{...a,loading:s})},[]),n=(0,w.useCallback)(async()=>{r(!0);let s=await O.getModelUsage();e(a=>({...a,...s})),r(!1)},[]),o=(0,w.useCallback)(async()=>{r(!0);let s=await O.refreshModelUsage();e(a=>({...a,...s,synced:!0})),r(!1)},[r]),l=X(({snapshot:s})=>async()=>{let{synced:a}=await s.getPromise(C);a||await o()},[o]),u=(0,w.useCallback)(async()=>{await O.clearModelUsage(),t()},[]),i=(0,w.useCallback)(J(o,500),[o]);return{loadModelUsage:n,clearModelUsage:u,refreshModelUsage:o,refreshModelUsageOnce:l,debounceRefreshModelUsage:i}},bt=()=>{let e=he(),t=Se();return{loading:e.loading,modelUsage:e,...t}};var ee=e=>{let t,r=new Set,n=(a,f)=>{let d=typeof a=="function"?a(t):a;if(!Object.is(d,t)){let m=t;t=f??(typeof d!="object"||d===null)?d:Object.assign({},t,d),r.forEach(h=>h(t,m))}},o=()=>t,i={setState:n,getState:o,getInitialState:()=>s,subscribe:a=>(r.add(a),()=>r.delete(a))},s=t=e(n,o,i);return i},te=e=>e?ee(e):ee;var D=p(z(),1);var ve=e=>e;function we(e,t=ve){let r=D.default.useSyncExternalStore(e.subscribe,()=>t(e.getState()),()=>t(e.getInitialState()));return D.default.useDebugValue(r),r}var re=e=>{let t=te(e),r=n=>we(t,n);return Object.assign(r,t),r},ne=e=>e?re(e):re;var c=p(z(),1),ze=p(ie(),1);function ke(e=!1){if(typeof e!="boolean")throw new Error("defaultValue must be `true` or `false`");let[t,r]=(0,c.useState)(e),n=(0,c.useCallback)(()=>{r(!0)},[]),o=(0,c.useCallback)(()=>{r(!1)},[]),l=(0,c.useCallback)(()=>{r(u=>!u)},[]);return{value:t,setValue:r,setTrue:n,setFalse:o,toggle:l}}var De=typeof window<"u"?c.useLayoutEffect:c.useEffect;function Be(e){let[t,r]=(0,c.useState)(e??0),n=(0,c.useCallback)(()=>{r(u=>u+1)},[]),o=(0,c.useCallback)(()=>{r(u=>u-1)},[]),l=(0,c.useCallback)(()=>{r(e??0)},[e]);return{count:t,increment:n,decrement:o,reset:l,setCount:r}}function Ne(e,t){let r=(0,c.useRef)(e);De(()=>{r.current=e},[e]),(0,c.useEffect)(()=>{if(t===null)return;let n=setInterval(()=>{r.current()},t);return()=>{clearInterval(n)}},[t])}function xt({countStart:e,countStop:t=0,intervalMs:r=1e3,isIncrement:n=!1}){let{count:o,increment:l,decrement:u,reset:i}=Be(e),{value:s,setTrue:a,setFalse:f}=ke(!1),d=(0,c.useCallback)(()=>{f(),i()},[f,i]),m=(0,c.useCallback)(()=>{if(o===t){f();return}n?l():u()},[o,t,u,l,n,f]);return Ne(m,s?r:null),[o,{startCountdown:a,stopCountdown:f,resetCountdown:d}]}function Qe(){let e=(0,c.useRef)(!1);return(0,c.useEffect)(()=>(e.current=!0,()=>{e.current=!1}),[]),(0,c.useCallback)(()=>e.current,[])}var ce={width:void 0,height:void 0};function At(e){let{ref:t,box:r="content-box"}=e,[{width:n,height:o},l]=(0,c.useState)(ce),u=Qe(),i=(0,c.useRef)({...ce}),s=(0,c.useRef)(void 0);return s.current=e.onResize,(0,c.useEffect)(()=>{if(!t.current||typeof window>"u"||!("ResizeObserver"in window))return;let a=new ResizeObserver(([f])=>{let d=r==="border-box"?"borderBoxSize":r==="device-pixel-content-box"?"devicePixelContentBoxSize":"contentBoxSize",m=ue(f,d,"inlineSize"),h=ue(f,d,"blockSize");if(i.current.width!==m||i.current.height!==h){let _={width:m,height:h};i.current.width=m,i.current.height=h,s.current?s.current(_):u()&&l(_)}});return a.observe(t.current,{box:r}),()=>{a.disconnect()}},[r,t,u]),{width:n,height:o}}function ue(e,t,r){return e[t]?Array.isArray(e[t])?e[t][0][r]:e[t][r]:t==="contentBoxSize"?e.contentRect[r==="inlineSize"?"width":"height"]:void 0}var le=ne(e=>({onStartPolling:null,onCompletePolling:null,setOnStartPolling:t=>{e({onStartPolling:t})},setOnStopPolling:t=>{e({onCompletePolling:t})}})),Ft=async e=>{if(await k.isLogin())return!0;let{maxWaitTime:r=3*60*1e3,customLoginCheck:n,emitEvent:o=!1}=e||{},{onStartPolling:l,onCompletePolling:u}=le.getState();if(o)if(l)await l();else return!1;return new Promise(async i=>{let s=null,a=async f=>{if(f?.data?.event==="MAX_AI_CONNECT_ACCOUNT"&&f.data.type==="COMPLETE"){window.removeEventListener("message",a),s&&clearTimeout(s);let d=n?await n():await k.isLogin();o&&u&&await u(d),i(d)}};s=setTimeout(()=>{i(!1)},r),window.addEventListener("message",a)})},zt=e=>{le.getState().setOnStartPolling(e)};export{Ze as a,O as b,he as c,Se as d,bt as e,xt as f,At as g,te as h,we as i,ne as j,Ft as k,zt as l};
